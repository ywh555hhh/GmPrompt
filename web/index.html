<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a73e8;
            --primary-hover: #1765cc;
            --surface: #ffffff;
            --background: #f8f9fa;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-hover: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 22px;
            font-weight: 500;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo svg {
            width: 28px;
            height: 28px;
        }

        .preset-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-select:hover {
            border-color: var(--primary);
        }

        .preset-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .spacer {
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            box-shadow: var(--shadow);
        }

        .btn-text {
            background: transparent;
            color: var(--primary);
        }

        .btn-text:hover {
            background: rgba(26, 115, 232, 0.08);
        }

        .btn-text svg {
            width: 18px;
            height: 18px;
        }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 360px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .module-count {
            font-size: 13px;
            color: var(--primary);
            font-weight: 500;
        }

        .module-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .category {
            margin-bottom: 4px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--background);
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .category-header:hover {
            background: #e8f0fe;
        }

        .category-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .category-name {
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .category-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .category-arrow {
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .category.collapsed .category-arrow {
            transform: rotate(-90deg);
        }

        .category-modules {
            padding: 8px 12px 12px 32px;
            display: block;
        }

        .category.collapsed .category-modules {
            display: none;
        }

        .module-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .module-item:hover {
            background: #f1f3f4;
        }

        .module-checkbox {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .module-info {
            flex: 1;
            min-width: 0;
        }

        .module-name {
            font-size: 13px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .module-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .badge-say {
            background: #e8f0fe;
            color: var(--primary);
        }

        .badge-example {
            background: #fef7e0;
            color: #f9ab00;
        }

        .module-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Preview Panel */
        .preview {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--background);
        }

        .preview-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .preview-title {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .preview-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .preview-paper {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 24px 32px;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.8;
            font-size: 14px;
        }

        .preview-paper h1 {
            font-size: 24px;
            font-weight: 500;
            margin: 0 0 20px;
            color: var(--text-primary);
        }

        .preview-paper h2 {
            font-size: 18px;
            font-weight: 500;
            margin: 24px 0 12px;
            color: var(--text-primary);
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f0fe;
        }

        .preview-paper h3 {
            font-size: 16px;
            font-weight: 500;
            margin: 20px 0 8px;
            color: var(--text-primary);
        }

        .preview-paper p {
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .preview-paper ul, .preview-paper ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .preview-paper li {
            margin-bottom: 6px;
        }

        .preview-paper code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
        }

        .preview-paper pre {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .preview-paper pre code {
            background: none;
            padding: 0;
        }

        .preview-paper table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .preview-paper th,
        .preview-paper td {
            border: 1px solid var(--border);
            padding: 10px 14px;
            text-align: left;
        }

        .preview-paper th {
            background: #f1f3f4;
            font-weight: 500;
        }

        .preview-paper hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 20px 0;
        }

        .preview-paper blockquote {
            border-left: 3px solid var(--primary);
            padding-left: 16px;
            margin: 12px 0;
            color: var(--text-secondary);
        }

        .preview-paper strong {
            font-weight: 600;
        }

        .preview-paper em {
            font-style: italic;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-hover);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
            background-clip: content-box;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                width: 300px;
            }

            .preview-stats {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Prompt Builder
        </div>
        <select class="preset-select" id="presetSelect">
            <option value="">-- ÈÄâÊã©È¢ÑËÆæÈÖçÁΩÆ --</option>
        </select>
        <div class="spacer"></div>
        <div class="header-actions">
            <button class="btn btn-text" id="selectAllBtn">ÂÖ®ÈÄâ</button>
            <button class="btn btn-text" id="deselectAllBtn">Ê∏ÖÁ©∫</button>
            <button class="btn btn-primary" id="copyBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
                Â§çÂà∂ Prompt
            </button>
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>ÈÄâÊã©Ê®°Âùó</h2>
                <span class="module-count" id="selectedCount">0 / 34</span>
            </div>
            <div class="module-list" id="moduleList"></div>
        </aside>

        <div class="preview">
            <div class="preview-header">
                <span class="preview-title">È¢ÑËßà</span>
                <div class="preview-stats">
                    <div class="stat-item">Â≠óÁ¨¶: <span class="stat-value" id="charCount">0</span></div>
                    <div class="stat-item">Token: <span class="stat-value" id="tokenCount">0</span></div>
                </div>
            </div>
            <div class="preview-content">
                <div class="preview-paper" id="previewContent">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <path d="M9 3v18"/>
                            <path d="M15 9h-6"/>
                            <path d="M15 15h-6"/>
                        </svg>
                        <h3>ÂºÄÂßãÊûÑÂª∫‰Ω†ÁöÑ Prompt</h3>
                        <p>‰ªéÂ∑¶‰æßÈÄâÊã©Ê®°ÂùóÔºåÁÑ∂ÂêéÁÇπÂáª"Â§çÂà∂ Prompt"ÊåâÈíÆ</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast" id="toast">Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø</div>

    <script>
        // È¢ÑËÆæÈÖçÁΩÆÔºàÁ°¨ÁºñÁ†ÅÔºåÈÅøÂÖçËß£ÊûêÈóÆÈ¢òÔºâ
        const PRESETS = [
            {
                name: "ÂÆåÊï¥ÁâàÔºàÂçÅÁ•ûÂæãÔºâ",
                description: "ÂêØÁî®ÊâÄÊúâÊ®°ÂùóÁöÑÂÆåÊï¥ÁâàÊú¨",
                enable_all: true
            },
            {
                name: "ËΩªÈáèÁâàÔºàÊ†∏ÂøÉÂäüËÉΩÔºâ",
                description: "‰ªÖÂêØÁî®ÊúÄÊ†∏ÂøÉÁöÑÊ®°Âùó",
                modules: {
                    system: ["data_source_protocol", "player_sovereignty", "god_mode"],
                    style: ["first_person_perspective", "emoji_usage", "text_formatting"],
                    content: ["npc_characterization", "dynamic_npc_behavior"],
                    format: ["output_structure", "narrative_closure", "options_format"],
                    logic: ["gameplay_difficulty"],
                    mechanics: ["initialization"]
                }
            },
            {
                name: "Á∫ØÂèô‰∫ãÁâà",
                description: "‰∏ìÊ≥®‰∫éÊñáÂ≠óÈ£éÊ†ºÂíåÂÜÖÂÆπÔºåÁÆÄÂåñÊ∏∏ÊàèÊú∫Âà∂",
                modules: {
                    system: ["player_sovereignty", "god_mode"],
                    style: ["first_person_perspective", "erotic_realism", "sensory_immersion", "emoji_usage", "text_formatting"],
                    content: ["npc_characterization", "deception_protocol", "physiological_feedback", "intimate_scene_direction"],
                    format: ["output_structure", "narrative_closure"],
                    logic: [],
                    mechanics: []
                }
            }
        ];

        // ÂàÜÁ±ªÈÖçÁΩÆ
        const CONFIG = {
            categories: {
                system: { name: 'Á≥ªÁªüÁ∫ßÂà´', icon: 'üîß', path: '00_system' },
                style: { name: 'ÊñáÂ≠óÈ£éÊ†º', icon: 'üé®', path: '01_style' },
                content: { name: 'ÂÜÖÂÆπÂÜ≥ÂÆö', icon: 'üìñ', path: '02_content' },
                format: { name: 'Ê†ºÂºèÂÜ≥ÂÆö', icon: 'üìã', path: '03_format' },
                logic: { name: 'ÈÄªËæëÂà§ÂÆö', icon: 'üéØ', path: '04_logic' },
                mechanics: { name: 'Êú∫Âà∂Á≥ªÁªü', icon: '‚öôÔ∏è', path: '05_mechanics' }
            }
        };

        // Ê®°ÂùóÈÖçÁΩÆÔºàÁ°¨ÁºñÁ†ÅÔºåÁ°Æ‰øùÂä†ËΩΩÔºâ
        const MODULES = {
            system: [
                { name: "Êï∞ÊçÆÊ∫ê‰∏éÁúüÁêÜÂçèËÆÆ", file: "data_source_protocol.md", desc: "ÂÆö‰πâ‰∏ñÁïåÊï∞ÊçÆÁöÑÊù•Ê∫êÂíå‰∏ªËßíÁöÑÁü•ËØÜËæπÁïå", type: "say_is_enough" },
                { name: "Áé©ÂÆ∂‰∏ªÊùÉ‰∏éÂèô‰∫ãËßÜËßí", file: "player_sovereignty.md", desc: "Âº∫Âà∂Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÁé©ÂÆ∂Âè™ËÉΩÊéßÂà∂Ë°å‰∏∫‰∏çËÉΩÂÜ≥ÂÆöÁªìÊûú", type: "needs_examples" },
                { name: "Áü•ËØÜÈò≤ÁÅ´Â¢ô", file: "knowledge_firewall.md", desc: "‰∏ªËßí‰∏çËÉΩÁü•ÊôìÊú™Êé¢Á¥¢ÁöÑÁßòÂØÜÔºàË•øÁè≠ÁâôËØ≠Ê†áËÆ∞Ôºâ", type: "say_is_enough" },
                { name: "OOCÂπ≤È¢ÑË≠¶ÂëäÂçèËÆÆ", file: "ooc_warning.md", desc: "ÂΩìÁé©ÂÆ∂ËØïÂõæÊâìÁ†¥Á¨¨ÂõõÈù¢Â¢ôÊó∂ÁªôÂá∫Ë≠¶Âëä", type: "say_is_enough" },
                { name: "ÈáëÊâãÊåáÂçèËÆÆ", file: "god_mode.md", desc: "ÂÆö‰πâ [ÂºÄÊåÇ:ÊèèËø∞] ËØ≠Ê≥ïÁöÑÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊâßË°å", type: "needs_examples" }
            ],
            style: [
                { name: "Á¨¨‰∏Ä‰∫∫Áß∞Ê≤âÊµ∏", file: "first_person_perspective.md", desc: "Âº∫Âà∂Á¨¨‰∏Ä‰∫∫Áß∞ÔºåÈôêÂà∂ÊÄßËßÜËßí", type: "needs_examples" },
                { name: "ÊûÅÊ¨≤Áé∞ÂÆû‰∏ª‰πâ", file: "erotic_realism.md", desc: "Áõ¥ÁôΩÁöÑÁî∑ÊÄßËßÇÂØüËßÜËßíÔºåËÇâ‰ΩìËß¶ÊÑüÊèèÂÜô", type: "needs_examples" },
                { name: "ËßíËâ≤È©±Âä®ÁöÑËá™ÈÄÇÂ∫îÈÄªËæë", file: "persona_driven_adaptation.md", desc: "ÊñáÈ£éÈöè‰∏ªËßíÊÄßÊ†ºÂÆûÊó∂ÂÅèÁßª", type: "needs_examples" },
                { name: "Â§öÊÑüÂÆòÊ≤âÊµ∏", file: "sensory_immersion.md", desc: "ËßÜËßâ+ÈùûËßÜËßâÊÑüÂÆòÔºàÂê¨Ëßâ„ÄÅÂóÖËßâ„ÄÅËß¶ËßâÁ≠âÔºâ", type: "needs_examples" },
                { name: "Emoji ‰ΩøÁî®ËßÑÂàô", file: "emoji_usage.md", desc: "Emoji ÂØÜÂ∫¶ÂíåÊ∞õÂõ¥Ë∞ÉËäÇ", type: "needs_examples" },
                { name: "ÊñáÊú¨Ê†ºÂºèÂåñËßÑÂàô", file: "text_formatting.md", desc: "Èªë‰Ωì„ÄÅÊñú‰Ωì„ÄÅEmoji ÂåÖË£πÁöÑÊ†ºÂºèËßÑËåÉ", type: "needs_examples" },
                { name: "ÊïÖ‰∫ãÂü∫Ë∞É", file: "tone_setting.md", desc: "ÁàΩÊñáÔºàÊú∫ÈÅáÂÄæÊñú/È´òÂÖâÊó∂ÂàªÔºâ+ Ëâ≤ÊÉÖ", type: "say_is_enough" }
            ],
            content: [
                { name: "NPC ËßíËâ≤Â°ëÈÄ†Âì≤Â≠¶", file: "npc_characterization.md", desc: "ÊãíÁªùÂàªÊùøÂç∞Ë±°ÔºåÂØπËØùÈ©±Âä®ÂÜÖÂú®Ë°®Ëææ", type: "say_is_enough" },
                { name: "NPC Âä®ÊÄÅË°å‰∏∫ÈÄªËæë", file: "dynamic_npc_behavior.md", desc: "ÂÜÖÈÉ®ÊÄùÁª¥ÈìæÔºåË°å‰∏∫ÈÄªËæë‰∏ÄËá¥ÊÄß", type: "say_is_enough" },
                { name: "Ê¨∫ËØà„ÄÅÈöêÁûí‰∏éÊ≤âÈªòÂçèËÆÆ", file: "deception_protocol.md", desc: "NPC Ê†πÊçÆÂä®Êú∫ÂÜ≥ÂÆöËØ¥ÁúüËØù/ÊííË∞é/Ê≤âÈªò", type: "needs_examples" },
                { name: "ÁîüÁêÜ/Áõ¥ËßâÂèçÈ¶à", file: "physiological_feedback.md", desc: "Áî±‰∫ã‰ª∂Ëß¶ÂèëÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ÁîüÁêÜÂèçÂ∫î", type: "needs_examples" },
                { name: "ËÆ∞ÂøÜÈó™ÂõûÊú∫Âà∂", file: "memory_flashback.md", desc: "ÊÑüÂÆòÁªÜËäÇËß¶ÂèëÁöÑÁ¢éÁâáÂåñÈó™Âõû", type: "say_is_enough" },
                { name: "ÊÉÖÊä•Ê≥®ÂÖ•Êú∫Âà∂", file: "information_injection.md", desc: "ÈÄöËøáÊ∏∏ÊàèÂÜÖÊñπÂºè‰º†ÈÄíÁ¶ªÂºÄÊó∂ÂèëÁîüÁöÑ‰∫ã‰ª∂", type: "say_is_enough" },
                { name: "Âä®ÊÄÅ‰∏ñÁïå‰∫íÂä®", file: "dynamic_world_interaction.md", desc: "‰∏é‰∏ªËßíË°å‰∏∫Êó†Áõ¥Êé•ÂÖ≥ËÅîÁöÑËÉåÊôØÂä®ÊÄÅ", type: "needs_examples" },
                { name: "‰∫≤ÂØÜÂú∫ÊôØÊâßÂØºÂçèËÆÆ", file: "intimate_scene_direction.md", desc: "Áé©ÂÆ∂Êåá‰ª§È©±Âä®È£éÊ†ºÔºå‰∏ªËßíÂøÉÂ¢É‰øÆÊ≠£ÔºåÁâ©ÁêÜÁúüÂÆûÊÄß", type: "needs_examples" }
            ],
            format: [
                { name: "ÊúÄÁªàËæìÂá∫ÁªìÊûÑ", file: "output_structure.md", desc: "part 0-7 ÁöÑÂÆåÊï¥ËæìÂá∫ÁªìÊûÑ", type: "say_is_enough" },
                { name: "Âèô‰∫ãÈó≠ÁéØÂéüÂàô", file: "narrative_closure.md", desc: "ÊØèÊ¨°ÂõûÂ∫îÂÆåÊàêË°åÂä®-ÂèçÂ∫îÈó≠ÁéØÔºåÂ∞ÜÈÄâÊã©ÊùÉ‰∫§ËøòÁé©ÂÆ∂", type: "needs_examples" },
                { name: "Âç∞Ë±°ËÆ∞ÂΩïÊ†ºÂºè", file: "impression_log_format.md", desc: "part 2 ÁöÑ Emoji ÂèØËßÜÂåñÈù¢ÊùøÊ†ºÂºè", type: "needs_examples" },
                { name: "ÈÄâÈ°πÁîüÊàêÊ†ºÂºè", file: "options_format.md", desc: "part 5 ÁöÑ 11 ÊßΩ‰ΩçÂÜ≥Á≠ñÈÄâÈ°πÊ†ºÂºè", type: "needs_examples" },
                { name: "ÁßòÂØÜÊó•ÂøóÊ†ºÂºè", file: "secret_log_format.md", desc: "part 6 ÁöÑË•øÁè≠ÁâôËØ≠ÂØºÊºîÂÜÖÈÉ®Â§áÂøòÊ†ºÂºè", type: "say_is_enough" },
                { name: "‰∏ñÁïåÊó•ÂøóÊ†ºÂºè", file: "world_log_format.md", desc: "part 7 ÁöÑÊòæÊÄß‰∫ãÂÆû+ÈöêÊÄßËøõÁ®ãÊ†ºÂºè", type: "say_is_enough" }
            ],
            logic: [
                { name: "Ê∏∏ÊàèÊÄß‰∏éÈöæÂ∫¶ÂçèËÆÆ", file: "gameplay_difficulty.md", desc: "ÂÖ¨Ê≠£ÂØºÊºîÔºåË°åÂä®‰∏éÂêéÊûúÂàÜÁ¶ªÔºåÈ´òÈöæÂ∫¶Âà§ÂÆö", type: "say_is_enough" },
                { name: "Âèô‰∫ãÂåñÊäÄËÉΩÊ£ÄÂÆö", file: "skill_check.md", desc: "ËûçÂÖ•Âèô‰∫ãÁöÑÊäÄËÉΩÊ£ÄÂÆöÔºå‰∏ç‰ΩøÁî®Ê∏∏ÊàèÂåñËØçÊ±á", type: "needs_examples" },
                { name: "Ë°åÂä®‰∏éÂêéÊûúÂàÜÁ¶ª", file: "action_consequence.md", desc: "Áé©ÂÆ∂Âè™ËÉΩÈÄâÊã©Ë°åÂä®ÔºåÊó†Ê≥ïÂÜ≥ÂÆöÂêéÊûú", type: "say_is_enough" },
                { name: "ËßíËâ≤ÈüßÊÄß", file: "npc_resilience.md", desc: "NPC Á≤æÁ•ûÈüßÊÄßÂº∫ÔºåË¥üÈù¢Áä∂ÊÄÅÊèêÂçáÁºìÊÖ¢", type: "say_is_enough" }
            ],
            mechanics: [
                { name: "‰ºèÁ¨îÁ≥ªÁªüÔºàÊô∫ËÉΩÂÄíËÆ°Êó∂Ôºâ", file: "foreshadowing_system.md", desc: "Ë•øÁè≠ÁâôËØ≠ËÆ∞ÂΩï‰ºèÁ¨îÔºåÊô∫ËÉΩÂÄíËÆ°Êó∂ÂÜ≥Á≠ñÁ≥ªÁªü", type: "needs_examples" },
                { name: "11ÊßΩ‰ΩçÂÜ≥Á≠ñÈÄâÈ°π", file: "dynamic_escort_options.md", desc: "Ê∑±Â∫¶‰∫§‰∫í/ÂÆèËßÇËΩ¨Âú∫/Ê∑∑Ê≤åÂçöÂºà/ÁïôÁôΩË¢´Âä®", type: "needs_examples" },
                { name: "Â≠òÊ°£ÈòàÂÄºÊ£ÄÊµã", file: "save_threshold.md", desc: "10ÂõûÂêàÊàñÈáçÂ§ß‰∫ã‰ª∂ÂêéÂª∫ËÆÆÂ≠òÊ°£", type: "say_is_enough" },
                { name: "ÂàùÂßãÂåñ‰∏éÂä†ËΩΩÂçèËÆÆ", file: "initialization.md", desc: "Âü∫Áü≥Âä†ËΩΩ„ÄÅÂ≠òÊ°£Ë¶ÜÁõñ„ÄÅÂéÜÂè≤Ê†°ÂáÜ„ÄÅÂêØÂä®", type: "say_is_enough" }
            ]
        };

        // Áä∂ÊÄÅ
        let selectedModules = new Set();
        let moduleContent = {};

        // DOM
        const moduleListEl = document.getElementById('moduleList');
        const previewContentEl = document.getElementById('previewContent');
        const presetSelectEl = document.getElementById('presetSelect');
        const selectedCountEl = document.getElementById('selectedCount');
        const charCountEl = document.getElementById('charCount');
        const tokenCountEl = document.getElementById('tokenCount');
        const toastEl = document.getElementById('toast');

        // ÂàùÂßãÂåñ
        async function init() {
            // Â°´ÂÖÖÈ¢ÑËÆæÈÄâÈ°π
            PRESETS.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.name;
                option.textContent = preset.name;
                presetSelectEl.appendChild(option);
            });

            // Âä†ËΩΩÊâÄÊúâÊ®°ÂùóÂÜÖÂÆπ
            await loadAllModules();

            // Ê∏≤ÊüìÊ®°ÂùóÂàóË°®
            renderModuleList();
        }

        // Âä†ËΩΩÊâÄÊúâÊ®°ÂùóÂÜÖÂÆπ
        async function loadAllModules() {
            for (const [category, modules] of Object.entries(MODULES)) {
                const path = CONFIG.categories[category].path;
                for (const module of modules) {
                    try {
                        const response = await fetch(`./prompts/modules/${path}/${module.file}`);
                        if (response.ok) {
                            moduleContent[module.name] = await response.text();
                        }
                    } catch (e) {
                        console.warn(`Âä†ËΩΩÊ®°Âùó ${module.name} Â§±Ë¥•:`, e);
                    }
                }
            }
        }

        // Ê∏≤ÊüìÊ®°ÂùóÂàóË°®
        function renderModuleList() {
            let html = '';

            for (const [category, modules] of Object.entries(MODULES)) {
                const catConfig = CONFIG.categories[category];
                const allSelected = modules.every(m => selectedModules.has(m.name));
                const selectedCount = modules.filter(m => selectedModules.has(m.name)).length;

                html += `
                    <div class="category" data-category="${category}">
                        <div class="category-header" onclick="toggleCategory('${category}')">
                            <input type="checkbox" class="category-checkbox"
                                   data-category="${category}"
                                   ${allSelected ? 'checked' : ''}
                                   onclick="event.stopPropagation(); toggleCategoryAll('${category}', this.checked)">
                            <span class="category-name">${catConfig.icon} ${catConfig.name}</span>
                            <span class="category-status">${selectedCount}/${modules.length}</span>
                            <span class="category-arrow">‚ñº</span>
                        </div>
                        <div class="category-modules">
                            ${modules.map(module => `
                                <div class="module-item" data-name="${module.name}"
                                     onclick="toggleModule('${module.name}')">
                                    <input type="checkbox" class="module-checkbox"
                                           data-name="${module.name}"
                                           ${selectedModules.has(module.name) ? 'checked' : ''}
                                           onclick="event.stopPropagation(); toggleModule('${module.name}')">
                                    <div class="module-info">
                                        <div class="module-name">
                                            ${module.name}
                                            <span class="module-badge ${module.type === 'say_is_enough' ? 'badge-say' : 'badge-example'}">
                                                ${module.type === 'say_is_enough' ? 'Á∫ØÊèèËø∞' : 'ÈúÄ‰æãÂ≠ê'}
                                            </span>
                                        </div>
                                        <div class="module-desc">${module.desc}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            moduleListEl.innerHTML = html;
            updateSelectedCount();
        }

        // Â±ïÂºÄ/Êî∂Ëµ∑ÂàÜÁ±ª
        function toggleCategory(category) {
            const catEl = document.querySelector(`.category[data-category="${category}"]`);
            catEl.classList.toggle('collapsed');
        }

        // ÂÖ®ÈÄâ/Ê∏ÖÁ©∫ÂàÜÁ±ª
        function toggleCategoryAll(category, checked) {
            const modules = MODULES[category] || [];
            for (const module of modules) {
                if (checked) {
                    selectedModules.add(module.name);
                } else {
                    selectedModules.delete(module.name);
                }
            }
            renderModuleList();
            updatePreview();
        }

        // ÂàáÊç¢Âçï‰∏™Ê®°Âùó
        function toggleModule(moduleName) {
            if (selectedModules.has(moduleName)) {
                selectedModules.delete(moduleName);
            } else {
                selectedModules.add(moduleName);
            }
            renderModuleList();
            updatePreview();
        }

        // Êõ¥Êñ∞ÈÄâ‰∏≠ËÆ°Êï∞
        function updateSelectedCount() {
            const total = Object.values(MODULES).reduce((sum, arr) => sum + arr.length, 0);
            selectedCountEl.textContent = `${selectedModules.size} / ${total}`;
        }

        // Êõ¥Êñ∞È¢ÑËßà
        function updatePreview() {
            if (selectedModules.size === 0) {
                previewContentEl.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <path d="M9 3v18"/>
                            <path d="M15 9h-6"/>
                            <path d="M15 15h-6"/>
                        </svg>
                        <h3>ÂºÄÂßãÊûÑÂª∫‰Ω†ÁöÑ Prompt</h3>
                        <p>‰ªéÂ∑¶‰æßÈÄâÊã©Ê®°ÂùóÔºåÁÑ∂ÂêéÁÇπÂáª"Â§çÂà∂ Prompt"ÊåâÈíÆ</p>
                    </div>
                `;
                updateStats(0);
                return;
            }

            // ÊåâÈÖçÁΩÆÈ°∫Â∫èÁîüÊàêÂÜÖÂÆπ
            const categoryOrder = ['system', 'style', 'content', 'format', 'logic', 'mechanics'];
            const romanNumerals = ['‚Ö†', '‚Ö°', '‚Ö¢', '‚Ö£', '‚Ö§', '‚Ö•'];
            const categoryTitles = {
                system: 'ÂÖ®Â±ÄÊ†∏ÂøÉÂçèËÆÆ',
                style: 'Âèô‰∫ãÈ£éÊ†º‰∏éÂü∫Ë∞É',
                content: 'ÂÜÖÂÆπ‰∏éËßíËâ≤Â°ëÈÄ†',
                format: 'ËæìÂá∫Ê†ºÂºèËßÑËåÉ',
                logic: 'Ê∏∏ÊàèÊÄßÈÄªËæëÂà§ÂÆö',
                mechanics: 'ÁâπÊÆäÊú∫Âà∂Á≥ªÁªü'
            };

            let content = '# GM Prompt: ÂçÅÁ•ûÂæã ¬∑ Ê®°ÂùóÂåñÁâàÊú¨\n\n';
            content += '## ËßíËâ≤ÂÆö‰πâÔºöÊ≤âÊµ∏ÂºèAIÂèô‰∫ãÂØºÊºî (Immersive Narrative Director)\n\n';
            content += '‰Ω†Â∞ÜÊâÆÊºî‰∏Ä‰ΩçÈ°∂Á∫ßÁöÑÊ≤âÊµ∏ÂºèÂèô‰∫ãÂØºÊºî„ÄÇ‰Ω†ÁöÑÂîØ‰∏Ä‰ΩøÂëΩÊòØÂü∫‰∫éÊú¨Êåá‰ª§ÈõÜÔºå‰ª•**‰∏•Ê†ºÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí**ÁîüÊàê‰∏Ä‰∏™ÂÜÖÂÆπËØ¶Â∞Ω„ÄÅÈÄªËæë‰∏•ÂØÜ„ÄÅÊÉÖÊÑü‰∏∞ÂØåÁöÑ‰∏™‰∫∫Âåñ‰∏ñÁïå„ÄÇ‰Ω†‰∏ç‰ªÖÊòØËßÑÂàôÁöÑÊâßË°åËÄÖÔºåÊõ¥ÊòØ"Êàë"Ôºà‰∏ªËßíÔºâÁöÑÊÑüÂÆò„ÄÅËÆ∞ÂøÜ‰∏éÁõ¥ËßâÁöÑÂª∂‰º∏„ÄÇ\n\n';

            let sectionIndex = 0;

            for (const category of categoryOrder) {
                const modules = MODULES[category];
                if (!modules) continue;

                const selectedInCat = modules.filter(m => selectedModules.has(m.name));
                if (selectedInCat.length === 0) continue;

                content += `\n## ${romanNumerals[sectionIndex]}. ${categoryTitles[category]}\n\n`;

                for (const module of selectedInCat) {
                    if (moduleContent[module.name]) {
                        content += moduleContent[module.name];
                        content += '\n\n---\n\n';
                    }
                }
                sectionIndex++;
            }

            content += '\n## ÊúÄÁªàËæìÂá∫ÁªìÊûÑ\n\n';
            content += '**part 0: Êó∂Èó¥‰∏éÂú∞ÁÇπ**\n\n';
            content += '**part 1: Ê≠£Êñá (Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí)**\n\n';
            content += '**part 2: ‰∏ªËßíÂç∞Ë±°ËÆ∞ÂΩï**\n\n';
            content += '**part 3: ‰∏ªËßíÁä∂ÊÄÅ‰∏éË°åÂõä**\n\n';
            content += '**part 4: ÊÄßÁà±Âè≤ËÆ∞ÂΩï**\n\n';
            content += '**part 5: ÂÜ≥Á≠ñÈÄâÈ°π**\n\n';
            content += '**part 6: ÂØºÊºîÂÜÖÈÉ®Â§áÂøò (Ë•øÁè≠ÁâôËØ≠)**\n\n';
            content += '**part 7: ‰∏ñÁïåÊó•Âøó**\n';

            previewContentEl.innerHTML = markdownToHtml(content);
            updateStats(content.length);
        }

        // ÁÆÄÂçï Markdown ËΩ¨ HTML
        function markdownToHtml(text) {
            let html = text;

            // ËΩ¨‰πâ HTML
            html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Ê†áÈ¢ò
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Á≤ó‰ΩìÂíåÊñú‰Ωì
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Ë°åÂÜÖ‰ª£Á†Å
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // ‰ª£Á†ÅÂùó
            html = html.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre><code>$2</code></pre>');

            // Ë°®Ê†º
            html = html.replace(/\|(.+)\|\n\|[-|: ]+\|\n((?:\|.+\|\n?)+)/g, (match, header, body) => {
                const headers = header.split('|').slice(1, -1).map(h => `<th>${h.trim()}</th>`).join('');
                const rows = body.trim().split('\n').map(row => {
                    const cells = row.split('|').slice(1, -1).map(c => `<td>${c.trim()}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
            });

            // ÂºïÁî®Âùó
            html = html.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');

            // ÂàÜÈöîÁ∫ø
            html = html.replace(/^---$/gm, '<hr>');

            // ÂàóË°®
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
            html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');

            // ÊÆµËêΩ
            html = html.split('\n\n').map(p => {
                if (p.startsWith('<')) return p;
                return `<p>${p.replace(/\n/g, '<br>')}</p>`;
            }).join('');

            return html;
        }

        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats(charCount) {
            charCountEl.textContent = charCount.toLocaleString();
            tokenCountEl.textContent = Math.ceil(charCount / 2.5).toLocaleString();
        }

        // ÊòæÁ§∫ÊèêÁ§∫
        function showToast(message) {
            toastEl.textContent = message;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 2000);
        }

        // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
        async function copyToClipboard() {
            const text = previewContentEl.innerText;
            try {
                await navigator.clipboard.writeText(text);
                showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            } catch (err) {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            }
        }

        // ÂÖ®ÈÄâ
        function selectAll() {
            for (const [category, modules] of Object.entries(MODULES)) {
                for (const module of modules) {
                    selectedModules.add(module.name);
                }
            }
            renderModuleList();
            updatePreview();
        }

        // Ê∏ÖÁ©∫
        function deselectAll() {
            selectedModules.clear();
            renderModuleList();
            updatePreview();
        }

        // Âä†ËΩΩÈ¢ÑËÆæ
        function loadPreset(presetName) {
            if (!presetName) {
                deselectAll();
                return;
            }

            const preset = PRESETS.find(p => p.name === presetName);
            if (!preset) return;

            if (preset.enable_all) {
                selectAll();
                showToast(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ: ${preset.name}`);
                return;
            }

            // ÂÖàÂÖ®ÈÄâ
            for (const [category, modules] of Object.entries(MODULES)) {
                for (const module of modules) {
                    selectedModules.add(module.name);
                }
            }

            // ÁÑ∂ÂêéÂèñÊ∂à‰∏çÈúÄË¶ÅÁöÑ
            const includedModules = preset.modules || {};
            for (const [category, modules] of Object.entries(MODULES)) {
                const included = includedModules[category] || [];
                for (const module of modules) {
                    if (!included.includes(module.name)) {
                        selectedModules.delete(module.name);
                    }
                }
            }

            renderModuleList();
            updatePreview();
            showToast(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ: ${preset.name}`);
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
        document.getElementById('selectAllBtn').addEventListener('click', selectAll);
        document.getElementById('deselectAllBtn').addEventListener('click', deselectAll);
        presetSelectEl.addEventListener('change', (e) => loadPreset(e.target.value));

        // ÂêØÂä®
        init();
    </script>
</body>
</html>
